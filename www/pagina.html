<!DOCTYPE HTML>
<html>
<head>

<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
<title>Ingreso de Fichas</title>
<link rel="stylesheet" type="text/css" href="fichasestilo/llenarfichas.css?v=4">
<link rel="stylesheet" type="text/css" href="fichasestilo/llenarfichase.css?v=1">
<link rel="stylesheet" type="text/css" href="fichasestilo/menullenarfichas.css">
<link rel="stylesheet" type="text/css" href="fichasestilo/pie.css">
<link rel="stylesheet" type="text/css" href="fichasestilo/editartabla.css">
<link rel="stylesheet" type="text/css" href="css/cabeza.css">
<link rel="stylesheet" type="text/css" href="css/ajax-loader.css">
<link rel="stylesheet" type="text/css" href="fichasestilo/mapas.css">
<link rel="stylesheet" type="text/css" href="css/mensaje_javascript.css">
<script src="https://solucionprofuturo.info/archivosbase/jquerymobile145/jquery-3.2.1.min.js"></script>
 <script src="https://solucionprofuturo.info/archivosbase/jquerymobile145/jquery.mobile-1.4.5.min.js"></script>
 <link rel="stylesheet" type="text/css" href="fichasestilo/formeter.css">
 <script src="fichasestilo/formeter.js"></script>

</head>

<body onload="tablasDiagIni();">
<div id="contenido">
<div id="cabeza">
<div id="logo">
<img src="fichasestilo/logo.png" alt="logo" >
</div>
<div id="titulo">

</div>
<div id="usuario">

</div>
<div class="limpiador"></div>
</div>
<div>
<table>
<tr><td><button type="button" onclick="actualizar();">Actualizar</button></td></tr>
<tr><td><button type="button" onclick="location.href='diagnostico.html';">Diagn&oacute;stico</button></td></tr>
<tr><td><button type="button" onclick="cerrarSecion();">Cerrar sesion</button></td></tr>
</table>
<table id="tablasDiag">
</table>
</div>
</div>
<script>
function actualizar(){
	var mensaje=document.getElementById('mensaje_javascript');
		mensaje.style.display='block';
var texto="<p>Aviso.</br>Se actualizara la app con los datos de la plataforma.</p>";
texto= texto + "<button type='button' onclick='cancelarconfiguauario(\"mensaje_javascript\");'>Cancelar</button>";
texto= texto + "<button type='button' onclick='actualizarI();'>Actualizar</button>";
		mensaje.childNodes[0].innerHTML=texto;
}
function actualizarI(){
document.getElementById('ajax-loader').style.display='block';
checkConnection();
}
function tablasDiagIni(){
db.transaction(tablasDiagIn);
}
function tablasDiagIn(tx){
//alert('err2');
document.getElementById('ajax-loader').style.display='block';
var texto="SELECT * FROM DiagnosticoP";
db.transaction(function(tx) {
		tx.executeSql ('SELECT * FROM DiagnosticoP', [], querySuccess, errorCB);
		});
}
function querySuccess (tx, results) {
var texto="<tr><th>AMIE</th><th>NOMBRE</th><th>FECHA</th><th>SUBIR</th></tr>";
for(var i=0; i<results.rows.length; i++){
texto=texto + "<tr><td>"+ results.rows.item(i)['preg3'] +"</td><td>"+ results.rows.item(i)['preg1'] +"</td><td>"+ results.rows.item(i)['preg2'] +"</td><td><button type='button' onclick='subirDiag(\""+ results.rows.item(i)['preg3'] +"\")'>SUBIR</button></td></tr>";
}
//alert ("devuelve filas =" + results.rows.item(0)['PROVINCIA']);
document.getElementById('tablasDiag').innerHTML=texto;
$('#ajax-loader').fadeOut();
}
function checkConnection() {
document.getElementById('ajax-loader').style.display='block';
    	$.ajax({
  			url: 'https://solucionprofuturo.info/',
  			async: false,
  			data: {'tag' : 'connection'}
  		})
  		.fail(function() {
		var mensaje=document.getElementById('mensaje_javascript');
		mensaje.style.display='block';
var texto="<p>Su dispositivo no esta conectado al Internet.</br></p>";
texto= texto + "<button type='button' onclick='cancelarconfiguauario(\"mensaje_javascript\");'>Aceptar</button>";
		mensaje.childNodes[0].innerHTML=texto;
		document.getElementById('ajax-loader').style.display='none';
		 })
  		.done(function() { 
		//alert('Online');
        db.transaction(populateDB, errorCB, successCB);
		 })
  }
  var db = window.openDatabase("Database", "1.0", "Cordova Demo", 200000);
  function populateDB(tx) {
       tx.executeSql('DROP TABLE IF EXISTS DiagnosticoP');
	   var txt='CREATE TABLE IF NOT EXISTS DiagnosticoP (ID , USUARIO, PROVINCIA, ';
	   for(var i=1; i<=192 ; i++){
	   if(i!=192){
	    txt=txt + 'preg' + i + ' ,';
	   }else{
	   txt=txt + 'preg' + i ;
	   }
	   }
	   txt=txt + ')';
	  // alert(txt);
   tx.executeSql(txt);
			var Provincia = localStorage.getItem('codigo') || '<empty>';
			//alert(Provincia);
		$.get( "https://solucionprofuturo.info/App/cargarDiag.php?ID=" + Provincia, function( data ) {
		var Diagnostico=data.split(';-;');
		//alert(Diagnostico.length);
		var preg=[];
		for(var j=0; j<Diagnostico.length; j++){
		 preg[j]=Diagnostico[j].split(':-:');
		if(preg[j][0]>0){
		//alert(preg[j][0]);
		var sqlT='INSERT INTO DiagnosticoP (ID , USUARIO , PROVINCIA , ';
		 for(var i=1; i<=192 ; i++){
	   if(i!=192){
	    sqlT=sqlT + 'preg' + i + ' , ';
	   }else{
	   sqlT=sqlT + 'preg' + i ;
	   }
	   }
		sqlT=sqlT + ') VALUES (';
		for(var i=0; i<(preg[j].length-1); i++){
		if(i!=(preg[j].length-2)){
	    sqlT=sqlT + '"' + preg[j][i] + '" , ';
	   }else{
	   sqlT=sqlT + '"' + preg[j][i] ;
	   }
		}
		sqlT=sqlT + '" )';
		guardarActu(sqlT);
		//alert(sqlT);
		//document.getElementById('tablasDiag').innerHTML='</br>'+ sqlT;
		//tx.executeSql('INSERT INTO DiagnosticoP (ID , USUARIO , PROVINCIA ) VALUES ("1" ,"2" , "3") ');
		//alert('err');
		}
		}
			//alert('err');
		tablasDiagIn(tx);
/*db.transaction(function(tx) {
		tx.executeSql ('SELECT * FROM DiagnosticoP', [], querySuccess, errorCB);
		});*/
		//alert('FIN');
		});
        /*tx.executeSql('INSERT INTO DEMO (id, data) VALUES (1, "First row")');
        tx.executeSql('INSERT INTO DEMO (id, data) VALUES (2, "Second row")');*/
		//while(sqlT.length>10){
		
	     
		// alert(sqlT);
			
		
		//}
		document.getElementById('mensaje_javascript').style.display="none";
		
    }

    // Transaction error callback
    //
	function guardarActu(sqlT){
	db.transaction(function(tx) {
		tx.executeSql(sqlT);
		});
	}
    function errorCB(tx, err) {
        alert("Error processing SQL: "+err);
    }

    // Transaction success callback
    //
    function successCB() {
        //alert("success!");
    }
	function subirDiag(AMIE){
	var mensaje=document.getElementById('mensaje_javascript');
		mensaje.style.display='block';
var texto="<p>Aviso.</br>Su ficha se subira a la base de datos.</p>";
texto= texto + "<button type='button' onclick='cancelarconfiguauario(\"mensaje_javascript\");'>Cancelar</button>";
texto= texto + "<button type='button' onclick='subirDiagI(\""+ AMIE +"\");'>Subir</button>";
		mensaje.childNodes[0].innerHTML=texto;
	}
	var ID_Usuario = localStorage.getItem('ID_Usuarios') || '<empty>';
	function subirDiagI(AMIE){
document.getElementById('ajax-loader').style.display='block';
    	$.ajax({
  			url: 'https://solucionprofuturo.info/',
  			async: false,
  			data: {'tag' : 'connection'}
  		})
  		.fail(function() {
		var mensaje=document.getElementById('mensaje_javascript');
		mensaje.style.display='block';
var texto="<p>Su dispositivo no esta conectado al Internet.</br></p>";
texto= texto + "<button type='button' onclick='cancelarconfiguauario(\"mensaje_javascript\");'>Aceptar</button>";
		mensaje.childNodes[0].innerHTML=texto;
		document.getElementById('ajax-loader').style.display='none';
		 })
  		.done(function() {
		
		db.transaction(function(tx) {
		tx.executeSql ('SELECT * FROM DiagnosticoP WHERE preg3="'+AMIE+'"', [], function(tx, results){
		
		for(var j=1; j<=16; j++){
		
		
		var links="https://solucionprofuturo.info/App/subirDiag.php?ID="+ results.rows.item(0)['ID'] +"&USUARIO="+ID_Usuario+"&PROVINCIA="+results.rows.item(0)['PROVINCIA']+"&AMIE="+results.rows.item(0)['preg3']+"";		
		//var links="https://solucionprofuturo.info/App/subirDiag.php?ID="+ results.rows.item(0)['ID'] +"&USUARIO="+ID_Usuario+"&PROVINCIA="+results.rows.item(0)['PROVINCIA']+"&AMIE="+results.rows.item(0)['preg3']+"";		
		for(var i=1+(12*(j-1)); i<=12*j; i++){
		var rsu=results.rows.item(0)['preg'+i].replace(/#/g, ":::");
		//rsu=rsu.replace(";#",";:");
		links=links+"&preg"+i+"="+ rsu;
		/*if(i==8){
		alert(links);
		}*/
		}
	
		
		enviarLDiag(links);
		}
		/*var mensaje=document.getElementById('mensaje_javascript');
		mensaje.style.display='block';
var texto="<p>Su ficha se ha subido con &eacute;xito.</br></p>";
texto= texto + "<button type='button' onclick='cancelarconfiguauario(\"mensaje_javascript\");'>Aceptar</button>";
		mensaje.childNodes[0].innerHTML=texto;
	document.getElementById('mensajeError').innerHTML=data;
	document.getElementById('ajax-loader').style.display='none';*/
	
		
		}, errorCB);
		});
		
	/*$.post( "https://solucionprofuturo.info/App/subirDiag.php", { name: "John", time: "2pm" })
	.fail(function() {
		var mensaje=document.getElementById('mensaje_javascript');
		mensaje.style.display='block';
var texto="<p>Error.</br></p>";
texto= texto + "<button type='button' onclick='cancelarconfiguauario(\"mensaje_javascript\");'>Aceptar</button>";
		mensaje.childNodes[0].innerHTML=texto;
		document.getElementById('ajax-loader').style.display='none';
		 })
  .done(function( data ) {
   var mensaje=document.getElementById('mensaje_javascript');
		mensaje.style.display='block';
var texto="<p>Su ficha se ha subido con &eacute;xito.</br></p>";
texto= texto + "<button type='button' onclick='cancelarconfiguauario(\"mensaje_javascript\");'>Aceptar</button>";
		mensaje.childNodes[0].innerHTML=texto;
	document.getElementById('ajax-loader').style.display='none';
  });*/
         })	
	}
	var textoT="";
	var NumExit=0;
	var NumErr=0;
	function enviarLDiag(links){
	$.get(links, function(data){
	//alert(data);
		if(data=="Exito"){
		NumExit=NumExit+1;
		}else{
		NumErr=NumErr+1;
		}
		/*textoT=textoT+data+links;
		document.getElementById('mensajeError').innerHTML=textoT;
		document.getElementById('ajax-loader').style.display='none';
		*/
		if(NumExit+NumErr==16){
		terminarSub();
		}
		});
	}
	function terminarSub(){
	if(NumExit==16){
	var mensaje=document.getElementById('mensaje_javascript');
		mensaje.style.display='block';
var texto="<p>Informaci&oacute;n</p><h3>Se ha guardado su diagn&oacute;stico.</h3>";
texto= texto + "<button type='button' onclick='cancelarconfiguauario(\"mensaje_javascript\");'>Aceptar</button>";
		mensaje.childNodes[0].innerHTML=texto;
	}else{
	var mensaje=document.getElementById('mensaje_javascript');
		mensaje.style.display='block';
var texto="<p>Informaci&oacute;n</p><h3>Error al guardar su diagn&oacute;stico.</br> Intente otra vez</h3>";
texto= texto + "<button type='button' onclick='cancelarconfiguauario(\"mensaje_javascript\");'>Aceptar</button>";
		mensaje.childNodes[0].innerHTML=texto;
	}
	document.getElementById('ajax-loader').style.display='none';
	}
  function cancelarconfiguauario(id){
	document.getElementById(id).style.display='none';
		}
	function cerrarSecion(){
	localStorage.clear();
	location.href="index.html";
	}
</script>
<div id="mensajeError"></div>
<div id='mensaje_javascript'><div></div></div>
<div id='ajax-loader'>
	<img src='img/ajax-loader.gif'/>
	</div>
</body>
</html>