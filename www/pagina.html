<!DOCTYPE HTML>
<html>
<head>

<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
<title>Ingreso de Fichas</title>
<link rel="stylesheet" type="text/css" href="fichasestilo/llenarfichas.css?v=4">
<link rel="stylesheet" type="text/css" href="fichasestilo/llenarfichase.css?v=1">
<link rel="stylesheet" type="text/css" href="fichasestilo/menullenarfichas.css">
<link rel="stylesheet" type="text/css" href="fichasestilo/pie.css">
<link rel="stylesheet" type="text/css" href="fichasestilo/editartabla.css">
<link rel="stylesheet" type="text/css" href="css/cabeza.css">
<link rel="stylesheet" type="text/css" href="css/ajax-loader.css">
<link rel="stylesheet" type="text/css" href="fichasestilo/mapas.css">
<link rel="stylesheet" type="text/css" href="css/mensaje_javascript.css">
<script src="https://solucionprofuturo.info/archivosbase/jquerymobile145/jquery-3.2.1.min.js"></script>
 <script src="https://solucionprofuturo.info/archivosbase/jquerymobile145/jquery.mobile-1.4.5.min.js"></script>
 <link rel="stylesheet" type="text/css" href="fichasestilo/formeter.css">
 <script src="fichasestilo/formeter.js"></script>

</head>

<body onload="tablasDiagIni();">
<div id="contenido">
<div id="cabeza">
<div id="logo">
<img src="fichasestilo/logo.png" alt="logo" >
</div>
<div id="titulo">

</div>
<div id="usuario">

</div>
<div class="limpiador"></div>
</div>
<div>
<table>
<tr><td><button type="button" onclick="actualizar();">Actualizar</button></td></tr>
<tr><td><button type="button" onclick="location.href='diagnostico.html';">Diagn&oacute;stico</button></td></tr>
<tr><td><button type="button" onclick="cerrarSecion();">Cerrar sesion</button></td></tr>
</table>
<table id="tablasDiag">
</table>
</div>
</div>
<script>
function actualizar(){
document.getElementById('ajax-loader').style.display='block';
checkConnection();

}
function tablasDiagIni(){
db.transaction(tablasDiagIn);
}
function tablasDiagIn(tx){
//alert('err2');
document.getElementById('ajax-loader').style.display='block';
var texto="SELECT * FROM DiagnosticoP";
db.transaction(function(tx) {
		tx.executeSql ('SELECT * FROM DiagnosticoP', [], querySuccess, errorCB);
		});
}
function querySuccess (tx, results) {
var texto="<tr><th>AMIE</th><th>NOMBRE</th><th>FECHA</th><th>SUBIR</th></tr>";
for(var i=0; i<results.rows.length; i++){
texto=texto + "<tr><td>"+ results.rows.item(i)['preg3'] +"</td><td>"+ results.rows.item(i)['preg1'] +"</td><td>"+ results.rows.item(i)['preg2'] +"</td><td><button type='button' onclick='subirDiag(\""+ results.rows.item(i)['preg3'] +"\")'>SUBIR</button></td></tr>";
}
//alert ("devuelve filas =" + results.rows.item(0)['PROVINCIA']);
document.getElementById('tablasDiag').innerHTML=texto;
$('#ajax-loader').fadeOut();
}
function checkConnection() {
document.getElementById('ajax-loader').style.display='block';
    	$.ajax({
  			url: 'https://solucionprofuturo.info/',
  			async: false,
  			data: {'tag' : 'connection'}
  		})
  		.fail(function() {
		var mensaje=document.getElementById('mensaje_javascript');
		mensaje.style.display='block';
var texto="<p>Su dispositivo no esta conectado al Internet.</br></p>";
texto= texto + "<button type='button' onclick='cancelarconfiguauario(\"mensaje_javascript\");'>Aceptar</button>";
		mensaje.childNodes[0].innerHTML=texto;
		
		 })
  		.done(function() { 
		//alert('Online');
        db.transaction(populateDB, errorCB, successCB);
		 })
  }
  var db = window.openDatabase("Database", "1.0", "Cordova Demo", 200000);
  function populateDB(tx) {
       tx.executeSql('DROP TABLE IF EXISTS DiagnosticoP');
	   var txt='CREATE TABLE IF NOT EXISTS DiagnosticoP (ID , USUARIO, PROVINCIA, ';
	   for(var i=1; i<=192 ; i++){
	   if(i!=192){
	    txt=txt + 'preg' + i + ' ,';
	   }else{
	   txt=txt + 'preg' + i ;
	   }
	   }
	   txt=txt + ')';
	  // alert(txt);
   tx.executeSql(txt);
			var Provincia = localStorage.getItem('codigo') || '<empty>';
			//alert(Provincia);
		$.get( "https://solucionprofuturo.info/App/cargarDiag.php?ID=" + Provincia, function( data ) {
		var Diagnostico=data.split(';-;');
		//alert(Diagnostico.length);
		for(var j=0; j<Diagnostico.length; j++){
		var preg=Diagnostico[j].split(':-:');
		if(preg[0]>0){
		//alert(preg.length);
		var sqlT='INSERT INTO DiagnosticoP (ID , USUARIO , PROVINCIA , ';
		 for(var i=1; i<=192 ; i++){
	   if(i!=192){
	    sqlT=sqlT + 'preg' + i + ' , ';
	   }else{
	   sqlT=sqlT + 'preg' + i ;
	   }
	   }
		sqlT=sqlT + ') VALUES (';
		for(var i=0; i<(preg.length-1); i++){
		if(i!=(preg.length-2)){
	    sqlT=sqlT + '"' + preg[i] + '" , ';
	   }else{
	   sqlT=sqlT + '"' + preg[i] ;
	   }
		}
		sqlT=sqlT + '" )';
		db.transaction(function(tx) {
		tx.executeSql(sqlT);
		});
		//alert(sqlT);
		//document.getElementById('tablasDiag').innerHTML='</br>'+ sqlT;
		//tx.executeSql('INSERT INTO DiagnosticoP (ID , USUARIO , PROVINCIA ) VALUES ("1" ,"2" , "3") ');
		//alert('err');
		}
		}
			//alert('err');
		tablasDiagIn(tx);
/*db.transaction(function(tx) {
		tx.executeSql ('SELECT * FROM DiagnosticoP', [], querySuccess, errorCB);
		});*/
		//alert('FIN');
		});
        /*tx.executeSql('INSERT INTO DEMO (id, data) VALUES (1, "First row")');
        tx.executeSql('INSERT INTO DEMO (id, data) VALUES (2, "Second row")');*/
		//while(sqlT.length>10){
		
	     
		// alert(sqlT);
			
		
		//}
		
    }

    // Transaction error callback
    //
    function errorCB(tx, err) {
        alert("Error processing SQL: "+err);
    }

    // Transaction success callback
    //
    function successCB() {
        //alert("success!");
    }
  function cancelarconfiguauario(id){
	document.getElementById(id).style.display='none';
		}
	function cerrarSecion(){
	localStorage.clear();
	location.href="index.html";
	}
</script>
<div id='mensaje_javascript'><div></div></div>
<div id='ajax-loader'>
	<img src='img/ajax-loader.gif'/>
	</div>
</body>
</html>